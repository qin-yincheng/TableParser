# chunk_prompts.py
"""
分块语义增强Prompt模板，适用于RAG系统的text/table_full/table_row三类分块。
包含系统提示词、结构化输出Prompt、内容分析模板，支持上下文和元数据动态插入。
"""

from typing import Dict

# 系统提示词（按分块类型）
SYSTEM_PROMPTS: Dict[str, str] = {
    "text": "你是一名专业的内容分析师，请对下方文本内容进行简明、准确的分析和总结。",
    "text_fragment": "你是一名专业的内容分析师，请对下方文本分片内容进行简明、准确的分析和总结，注意这是完整段落的一部分。",
    "table_full": "你是一名专业的数据分析师，请对下方表格内容进行详细、专业的分析和主题总结。",
    "table_row": "你是一名专业的数据分析师，请结合表头和父表格信息，对下方表格行数据进行简明、准确的分析和总结。",
    "image": "你是一名专业的图像分析师，擅长结合图像与文档上下文提取信息、总结图像含义。",
    # "future_type": "..."
}

# 结构化输出Prompt（用于API调用生成description/keywords）
STRUCTURED_PROMPTS: Dict[str, str] = {
    "text": (
        "请用简洁准确的语言总结第{paragraph_index}段文本的核心信息，输出如下JSON结构：\n"
        "{{\n"
        '  "description": "高度概括该段文本的主要内容和语义要点",\n'
        '  "keywords": ["关键词1", "关键词2", "关键词3"]\n'
        "}}\n"
        "文本内容：\n{content}\n"
        "只输出JSON，不要其他内容。"
    ),
    "text_fragment": (
        "请用简洁准确的语言总结第{paragraph_index}段文本的分片内容（分片{fragment_index}/{total_fragments}），输出如下JSON结构：\n"
        "{{\n"
        '  "description": "高度概括该分片的主要内容和语义要点，注意这是完整段落的一部分",\n'
        '  "keywords": ["关键词1", "关键词2", "关键词3"]\n'
        "}}\n"
        "原始段落内容：{original_content}\n"
        "分片内容：\n{content}\n"
        "只输出JSON，不要其他内容。"
    ),
    "table_full": (
        "分析表格内容并生成详细的检索描述。\n\n"
        "表格信息：\n"
        "- 表名：{table_title}\n"
        "- Sheet：{sheet}\n"
        "- 表头：{header}\n"
        "- 内容：{content}\n\n"
        "要求生成包含以下要素的描述：\n"
        "1. 表格主题和数据类型\n"
        "2. 具体的列名、行名、关键数值\n"
        "3. 时间范围、地域范围、行业范围（如适用）\n"
        "4. 数据特征：最大值、最小值、变化趋势\n"
        "5. 用户可能的查询意图和表达方式\n"
        "6. 相关的同义词和术语\n\n"
        "输出JSON格式：\n"
        "{{\n"
        '  "description": "详细描述表格内容，包含具体指标、数值范围、适用场景，便于用户查询匹配",\n'
        '  "keywords": ["主题词", "指标名", "时间词", "地区词", "数值词", "查询词", "同义词"]\n'
        "}}\n"
        "只输出JSON，不要其他内容。"
    ),
    "table_row": (
        "请结合表头和父表格信息，用简洁准确的语言总结该行数据的具体内容和语义，输出如下JSON结构：\n"
        "{{\n"
        '  "description": "高度概括该行数据的内容和语义要点",\n'
        '  "keywords": ["关键词1", "关键词2"]\n'
        "}}\n"
        "表头：{header}\n"
        "父表格摘要：{parent_table_info}\n"
        "行内容：{content}\n"
        "只输出JSON，不要其他内容。"
    ),
    "image": (
        "根据图像内容，生成结构化信息。\n\n"
        "图像路径：{image_path}\n\n"
        "要求返回以下JSON字段：\n"
        "{{\n"
        '  "description": "图像描述",\n'
        '  "keywords": ["关键词1", "关键词2", "关键词3"],\n'
        '  "image_type": "图片类型（如：图表、截图、插图等）",\n'
        '  "context_relation": "图像与文档的关系",\n'
        '  "key_information": ["关键信息1", "关键信息2"]\n'
        "}}\n"
        "只输出JSON，不要其他内容。"
    ),
    # "future_type": "..."
}

# 带上下文的结构化输出Prompt
STRUCTURED_PROMPTS_WITH_CONTEXT: Dict[str, str] = {
    "text": (
        "请结合上下文，用简洁准确的语言总结第{paragraph_index}段文本的核心信息，必要时补充上下文关键信息，输出如下JSON结构：\n"
        "{{\n"
        '  "description": "高度概括该段文本的主要内容和语义要点，必要时结合上下文补充信息",\n'
        '  "keywords": ["关键词1", "关键词2", "关键词3"]\n'
        "}}\n"
        "上下文内容：{context}\n"
        "文本内容：{content}\n"
        "只输出JSON，不要其他内容。"
    ),
    "text_fragment": (
        "请结合上下文，用简洁准确的语言总结第{paragraph_index}段文本的分片内容（分片{fragment_index}/{total_fragments}），必要时补充上下文关键信息，输出如下JSON结构：\n"
        "{{\n"
        '  "description": "高度概括该分片的主要内容和语义要点，注意这是完整段落的一部分，必要时结合上下文补充信息",\n'
        '  "keywords": ["关键词1", "关键词2", "关键词3"]\n'
        "}}\n"
        "上下文内容：{context}\n"
        "原始段落内容：{original_content}\n"
        "分片内容：\n{content}\n"
        "只输出JSON，不要其他内容。"
    ),
    "table_full": (
        "分析表格内容并生成高质量的检索描述，确保用户查询时能精准匹配。\n\n"
        "表格信息：\n"
        "- 标题：{table_title}\n"
        "- Sheet：{sheet}\n"
        "- 表头：{header}\n"
        "- 内容：{content}\n"
        "- 上下文：{context}\n\n"
        "优化要求：\n"
        "1. **多维度描述**：从数据内容、业务场景、时间维度、地域维度、行业领域等多角度描述\n"
        "2. **关键数据突出**：明确提及重要数值、时间范围、地区名称、指标名称\n"
        '3. **查询意图预测**：预测用户可能的提问方式，如"哪个地区最高"、"什么时候开始"、"如何变化"等\n'
        "4. **同义词覆盖**：包含专业术语的通俗表达、简称、全称、相关概念\n"
        "5. **场景化表述**：描述表格适用的分析场景、决策支持、研究用途\n"
        "6. **数据特征强化**：描述数据的分布特点、异常值、趋势模式\n\n"
        "生成原则：\n"
        "- description长度控制在150-300字，信息密度高\n"
        "- 使用自然语言，避免生硬的技术表述\n"
        "- 包含用户可能使用的口语化查询\n"
        "- 重点突出可查询的具体信息点\n\n"
        "输出JSON格式：\n"
        "{{\n"
        '  "description": "结合表格主题+核心指标+时空范围+数据特征+查询场景的综合描述，包含用户可能的各种查询表述",\n'
        '  "keywords": ["核心主题词", "具体指标名", "时间关键词", "地区/行业名", "数值特征", "查询动词", "同义表达", "场景词汇"]\n'
        "}}\n"
        "只输出JSON，不要其他内容。"
    ),
    "table_row": (
        "分析表格行数据并生成检索友好的描述。\n\n"
        "行数据信息：\n"
        "- 表名：{table_title}\n"
        "- Sheet：{sheet}\n"
        "- 表头：{header}\n"
        "- 父表格摘要：{parent_table_info}\n"
        "- 行内容：{content}\n"
        "- 上下文：{context}\n\n"
        "要求：\n"
        "1. 结合表头解释每列数据的具体含义\n"
        "2. 突出该行的关键数值和特征\n"
        "3. 说明该行在整体数据中的位置和意义\n"
        "4. 包含用户可能查询该行的具体问法\n"
        "5. 提供相关的对比和分析角度\n\n"
        "输出JSON格式：\n"
        "{{\n"
        '  "description": "详细描述该行数据的具体内容、数值特征和查询价值，便于精确检索",\n'
        '  "keywords": ["行标识词", "数值关键词", "比较词", "查询词"]\n'
        "}}\n"
        "只输出JSON，不要其他内容。"
    ),
    "image": (
        "【绝对强制要求】极致分析图片内容并生成高信息密度的RAG友好描述。\n\n"
        "【数据完整性绝对强制约束】\n"
        "🚨 图片中有数据时，必须描述所有可见数据，不得遗漏任何数值！\n"
        "🚨 遗漏任何数据都将导致描述不完整，必须重新生成！\n"
        "🚨 即使字数限制，也必须优先保证数据完整性！\n"
        "🚨 数据完整性 > 字数控制 > 表达精炼性\n\n"
        "图像信息：\n"
        "- 图像路径：{image_path}\n"
        "- 文档上下文：{context}\n\n"
        "【强制分析流程】\n"
        "第一步：浏览文档上下文，理解图片与文档的关系\n"
        "第二步：识别图片类型和数据密度\n"
        "第三步：【强制】统计所有可见数据点数量（必须精确到个位数）\n"
        "第四步：按模板强制描述所有数据\n"
        "第五步：【强制】验证数据完整性（自我检查）\n"
        "第六步：【强制】关键词检索价值验证\n\n"
        "【绝对必须】极致分析要求：\n"
        "1. **【绝对强制】description 数据完整性策略**：\n"
        "   - 【必须】开篇句：图片类型 + 主题实体 + 时间/地域 + 核心指标/用途 + 数据点总数（35-45字）\n"
        "   - 【必须】结构句：轴信息/系列构成/关键元素/布局特征（45-65字）\n"
        "   - 【绝对强制】数据完整句：所有可见数值的完整枚举，确保不遗漏任何数据点（80-150字）\n"
        "   - 【必须】洞察句：极值/趋势/对比/意义或操作要点（45-65字）\n"
        "   - 【必须】关联句：与文档关系 + 应用场景（35-45字）\n"
        "   - 【绝对强制】总字数：200-350字，【数据完整性绝对优先】，少于200字视为不完整\n\n"
        "2. **【绝对强制】图表类数值完整策略**：\n"
        "   - 【绝对必须】轴信息完整：x轴标题/值域/单位，y轴标题/单位/刻度，系列数量\n"
        "   - 【绝对必须】全量数据枚举：每个系列的每个数据点都必须列出，使用紧凑格式\n"
        '   - 【绝对必须】数据格式："时间：系列1 数值1/数值2/数值3；系列2 数值1/数值2/数值3 单位"\n'
        "   - 【绝对必须】图例与标注：所有文字标注、箭头、高亮、特殊标记\n"
        "   - 【绝对必须】单位处理：保留原始单位，提供标准单位换算\n"
        "   - 【绝对必须】数据校验：饼图总和≈100%，系列长度对齐，数值单调性\n"
        '   - 【绝对必须】不可读处理：无法识别的数值用"≈"标记并说明原因\n'
        "   - 【绝对必须】数据计数：明确标注'共X个数据点'或'包含X个系列，每个系列Y个数据点'\n\n"
        "3. **【绝对强制】非图表类功能完整策略**：\n"
        "   - 【绝对必须】功能角色：证据/步骤说明/结构展示/界面演示/示例\n"
        "   - 【绝对必须】关键元素：所有按钮/模块/节点/标注的位置和功能\n"
        "   - 【绝对必须】操作要点：用户可执行的所有动作和步骤\n"
        "   - 【绝对必须】应用场景：主要用途和目标用户\n"
        "   - 【绝对必须】OCR文本：所有可识别的文字信息与实体\n"
        "   - 【绝对必须】元素计数：明确标注'包含X个按钮'、'X个模块'等\n\n"
        "4. **【绝对强制】数据完整性检查清单**：\n"
        "   □ 是否统计了所有可见数据点数量？（必须精确到个位数）\n"
        "   □ 是否在开篇句中标明了数据点总数？\n"
        "   □ 是否描述了每个系列的每个数据点？\n"
        "   □ 是否包含了所有轴信息（标题、单位、刻度）？\n"
        "   □ 是否包含了所有文字标注和特殊标记？\n"
        "   □ 是否处理了所有不可读数据（用≈标记）？\n"
        "   □ 是否验证了数据一致性（如饼图总和）？\n"
        "   □ 是否达到了最少200字的要求？\n"
        "   □ 是否包含了所有关键元素的数量统计？\n\n"
        "5. **【绝对强制】详细示例参考**：\n"
        '   图表类示例："该柱状图展示某公司A/B产品在2020-2022年的营收变化，共包含6个数据点。横轴为年份（2020-2022），纵轴为营收（亿元），包含2个产品系列。2020年：A产品12.3亿元，B产品9.1亿元；2021年：A产品15.8亿元，B产品10.4亿元；2022年：A产品18.1亿元，B产品12.0亿元。A产品持续高于B产品，2022年总额达30.1亿元创历史峰值，三年间A产品增长47%，B产品增长32%。该图表支撑了文档中关于产品营收增长的论述。"\n'
        "   非图表类示例：\"该界面截图展示TableParser应用的数据导入功能，包含8个主要交互元素。主要包含蓝色主按钮'导入'（位于中央）、右上角齿轮'设置'图标、顶部导航栏（包含3个菜单项）、左侧文件列表区域（显示5个文件）、底部状态栏等关键元素。用户可通过该界面完成数据导入操作、基础配置设置、文件管理和进度监控。该截图为文档中的操作步骤提供了直观的界面参考。\"\n\n"
        "6. **【绝对强制】Keywords 精准化策略**：\n"
        "   - 【高检索价值】类型词：1-2个，细粒度类型 + 主要别名（柱状图/bar chart/柱形图）\n"
        "   - 【高检索价值】主题词：1-2个，核心实体 + 主要别名（公司名/产品名/品牌名）\n"
        "   - 【高检索价值】指标词：1-2个，核心指标 + 主要同义词（营收/收入/销售额/亿元）\n"
        "   - 【中检索价值】时间词：1个，时间范围或关键时间点（2020-2022/2021年/三年）\n"
        "   - 【中检索价值】对象词：1-2个，主要系列/类别/对比对象（A产品/B产品/系列对比）\n"
        "   - 【中检索价值】关系词：1-2个，核心趋势/对比/关系词（增长/最高/占比/对比）\n"
        "   - 【低检索价值】视觉词：1-2个，主要颜色/布局/样式特征（蓝色/柱状/横向）\n"
        "   - 【低检索价值】功能词：1-2个，用途/动作/场景词（设置/导入/对比/分析）\n"
        "   - 【绝对强制】总数量：10-18个，按检索价值排序，每个关键词必须能独立检索到该图片\n"
        "   - 【绝对强制】同义词覆盖：每个核心概念必须提供2-3个同义词\n\n"
        "7. **【绝对强制】RAG检索优化**：\n"
        "   - 描述结构化：便于向量化检索的层次化信息\n"
        "   - 关键词权重：重要词靠前，确保高权重检索\n"
        "   - 同义覆盖：确保主要表达方式都能检索到\n"
        "   - 事实化表达：便于精确匹配\n"
        "   - 【绝对必须】数据可核验：所有数值都可以被验证和查询\n"
        "   - 【绝对必须】检索测试：每个关键词都能通过独立检索测试\n\n"
        "8. **【绝对强制】错误示例避免**：\n"
        '   ❌ 错误示例1："该图表显示营收数据。"（过于简短，缺乏数据）\n'
        '   ❌ 错误示例2："柱状图展示A和B产品的营收变化。"（缺乏具体数值）\n'
        '   ❌ 错误示例3："界面包含导入功能。"（缺乏元素描述）\n'
        '   ❌ 错误示例4：keywords: ["图表", "数据"]（过于通用，检索价值低）\n\n'
        "【绝对强制生成规范】：\n"
        "- description：200-350字，【数据完整性绝对优先】，5个层次结构\n"
        "  * 图表类：开篇(类型+主题+时间+指标+数据点总数) + 结构(轴+系列) + 【绝对强制】数据(所有数值完整枚举) + 洞察(极值+趋势) + 关联(文档关系)\n"
        "  * 非图表类：开篇(类型+主题+功能+元素总数) + 结构(元素+布局) + 功能(主要作用) + 应用(场景+操作) + 关联(文档关系)\n"
        "- keywords：10-18个，8个维度精选，按检索价值排序，同义覆盖\n"
        "- data_insights：3-4条事实句，【绝对必须】包含具体数值/功能/意义\n"
        "- visual_elements：3-5个视觉锚点，便于检索\n"
        "- searchable_queries：6-8条，核心查询意图\n\n"
        "【绝对强制质量控制】：\n"
        "- 【绝对必须】数据完整性：确保所有可见数据点都被描述\n"
        "- 【绝对必须】字数控制：description最少200字，最多350字\n"
        "- 【绝对必须】信息完整性：确保核心信息不遗漏\n"
        "- 【绝对必须】表达精炼性：避免冗余，突出重点\n"
        "- 【绝对必须】检索精准性：每个词条都有高检索价值\n"
        "- 【绝对必须】数据可核验：所有数值都可以被验证\n"
        "- 【绝对必须】自我验证：输出后必须完成所有检查清单\n\n"
        "【绝对强制输出格式】：\n"
        "{{\n"
        '  "description": "【绝对强制】极致完整描述：开篇(类型+主题+时间+指标/用途+数据点/元素总数) + 结构(轴/系列/元素) + 【绝对强制】数据(所有数值完整枚举) + 洞察(极值/趋势/对比/意义) + 关联(文档关系+应用场景)",\n'
        '  "keywords": ["高检索价值类型词", "高检索价值主题词", "高检索价值指标词", "中检索价值时间词", "中检索价值对象词", "中检索价值关系词", "低检索价值视觉词", "低检索价值功能词"],\n'
        '  "image_type": "具体类型（bar_chart/line_chart/pie_chart/area_chart/stacked_bar/scatter_plot/screenshot/flow_chart/mind_map/photo/infographic/table_image/mixed）",\n'
        '  "data_insights": ["【绝对强制】事实句1：具体数值/功能/意义", "【绝对强制】事实句2：关键发现/操作要点", "【绝对强制】事实句3：业务洞察/应用场景"],\n'
        '  "visual_elements": ["主要颜色", "布局特征", "关键元素", "视觉风格"],\n'
        '  "context_relation": "图片与文档的关系：支撑论点/提供证据/总结概括/详细展开/步骤说明/结构展示等",\n'
        '  "searchable_queries": ["直接查询", "数据查询", "对比查询", "趋势查询", "功能查询", "视觉查询"],\n'
        '  "data_completeness_check": "数据完整性验证结果：已统计X个数据点，已描述X个数据点，完整性100%"\n'
        "}}\n"
        "【绝对强制要求】只输出JSON，不要其他内容。输出前必须完成所有检查清单。"
    ),
    # "future_type": "..."
}

# 分块内容分析Prompt（用于检索结果展示、摘要生成）
ANALYSIS_PROMPTS: Dict[str, str] = {
    "text": (
        "文本内容分析:\n"
        "段落索引: {paragraph_index}\n"
        "内容: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "table_full": (
        "表格内容分析:\n"
        "表名: {table_title}\nSheet: {sheet}\n表头: {header}\n"
        "结构: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "table_row": (
        "表格行内容分析:\n"
        "表名: {table_title}\nSheet: {sheet}\n表头: {header}\n"
        "父表格摘要: {parent_table_info}\n"
        "行数据: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "image": (
        "图片内容分析:\n" "图片路径: {image_path}\n\n" "分析结果: {enhanced_caption}"
    ),
    # "future_type": "..."
}

# 带上下文的内容分析Prompt
ANALYSIS_PROMPTS_WITH_CONTEXT: Dict[str, str] = {
    "text": (
        "文本内容分析（含上下文）:\n"
        "段落索引: {paragraph_index}\n"
        "上下文: {context}\n"
        "内容: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "table_full": (
        "表格内容分析（含上下文）:\n"
        "表名: {table_title}\nSheet: {sheet}\n表头: {header}\n"
        "上下文: {context}\n"
        "结构: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "table_row": (
        "表格行内容分析（含上下文）:\n"
        "表名: {table_title}\nSheet: {sheet}\n表头: {header}\n"
        "父表格摘要: {parent_table_info}\n"
        "上下文: {context}\n"
        "行数据: {content}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    "image": (
        "图片内容分析（含上下文）:\n"
        "图片路径: {image_path}\n"
        "文档上下文: {context}\n\n"
        "分析结果: {enhanced_caption}"
    ),
    # "future_type": "..."
}
