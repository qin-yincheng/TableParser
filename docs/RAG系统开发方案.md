 # RAG系统开发整体方案

## 一、项目目标

构建一个支持Word（doc/docx）和Excel（xlsx）文档精准解析与检索的RAG（Retrieval-Augmented Generation）系统，实现表格和文本的结构化提取、多粒度分块、向量化、上下文链接与高效检索，最终为LLM生成高质量答案提供丰富上下文。

---

## 二、系统架构与模块划分

### 1. 文档解析层
- **Word解析**：基于`doc_parser.py`，使用`python-docx`提取段落和表格。
- **Excel解析**：新增`xlsx_parser.py`，使用`openpyxl`或`pandas`提取多Sheet表格。
- **输出结构**：
  - 文本：按段落输出字符串列表。
  - 表格：输出结构化数据（如二维数组、DataFrame），并附带元数据（表名、Sheet名、行列号等）。

### 2. 分块与结构化层
- **分块策略**：
  - 文本：按段落或固定长度分块。
  - 表格：
    - 整表分块：将整个表格转为Markdown格式。
    - 行级分块：每行转为带列标题的描述性文本或Markdown片段。
- **分块输出**：每个分块为字典，包含内容、类型、来源、元数据。
- **分块逻辑**：直接集成在各自parser中，输出即为分片好的结构。

### 3. 元数据与上下文链接
- **元数据**：每个分块附带文档ID、页码、表格/Sheet名、分块类型、父子关系等。
- **上下文链接**：
  - 文本与表格分块建立父子关系（如段落与其后表格）。
  - 整表分块与行级分块建立父子关系。

### 4. 语义丰富与描述生成
- **表格描述**：可选用LLM为整表及行级分块生成自然语言描述，增强语义检索能力。
- **关键词提取**：自动从标题、内容、描述中提取关键词，作为检索元数据。

### 5. 向量化与存储
- **向量化策略**：
  - 整表Markdown、行级描述文本分别生成向量。
  - 结合元数据、描述等信息进行多粒度嵌入。
- **向量库**：如Weaviate，Schema需支持内容、元数据、父子关系、向量等字段。

### 6. 检索与生成
- **检索流程**：
  - 用户查询经LLM扩展/重写。
  - 在向量库中混合检索（向量+关键词过滤）。
  - 检索结果按父子关系补全上下文。
- **生成流程**：
  - 检索到的文本和表格（Markdown格式）组装为LLM输入上下文。
  - LLM生成最终答案。

---

## 三、开发落地路径

### 1. 解析器开发
- 保持`doc_parser.py`现有结构。
- 新建`xlsx_parser.py`，实现Excel多Sheet、表格结构化提取与分片。
- 统一parser接口：`parse(file_path) -> List[Dict]`，每个dict为一个分块。

### 2. 分块与结构化
- 在parser内部实现分片，输出分片好的结构。
- 分块结构示例：
```python
{
  "type": "table_row",  # 或 table_full/text
  "content": "| 年份 | 收入 | 支出 |\n| 2022 | 1000 | 800 |",
  "metadata": {
    "sheet": "Sheet1",
    "row": 2,
    "table_title": "财务数据表"
  },
  "parent_id": "table_1"
}
```

### 3. 元数据与上下文
- 设计分块结构时，附带所有必要元数据。
- 建立分块间的父子关系，便于后续检索时补全上下文。

### 4. 向量化与存储
- 外部模块（如`vector_service.py`）负责将分块内容及描述转为向量，并存入向量库。
- Schema设计需支持多粒度分块、元数据、父子关系。

### 5. 检索与生成
- 检索时支持混合搜索（向量+关键词+元数据过滤）。
- 检索结果按父子关系补全上下文，组装为LLM输入。
- LLM生成最终答案。

---

## 四、各模块输入输出与向量化字段

### 1. 文档解析层
- **输入**：文件路径（Word/Excel）
- **输出**：分块字典列表，每个分块结构如下：
```python
{
  "type": "text" / "table_full" / "table_row",
  "content": "...",  # 段落文本、Markdown表格、行描述等
  "metadata": {
    "doc_id": "...",
    "page": 1,
    "sheet": "Sheet1",  # Excel特有
    "table_title": "...",
    "row": 2,            # 行分块特有
    ...
  },
  "parent_id": "table_1"  # 可选，行分块指向整表分块
}
```

### 2. 分块与结构化层
- **输入**：解析器输出的原始结构化数据（如DataFrame、段落列表）
- **输出**：分块字典列表（如上），类型包括text、table_full、table_row等，附带元数据。

### 3. 语义丰富与描述生成（LLM）
- **输入**：每个分块的content字段
- **输出**：
  - `description`（自然语言描述/摘要）
  - `keywords`（关键词列表）
- **集成方式**：将description、keywords作为新字段加入每个分块的metadata中。

### 4. 向量化与存储
- **输入**：每个分块的content、description、keywords
- **输出**：
  - 向量（embedding）
  - 存储对象（含内容、元数据、向量等）写入向量库
- **最终做向量化的字段**：
  - 对于每个分块，向量化字段为：
    `embedding_input = content + '\n' + description + '\n' + ','.join(keywords)`
  - 若description/keywords为空，仅用content。

### 5. 检索与生成
- **输入**：用户查询（可扩展/重写）、向量库检索结果（分块及其元数据、内容、向量）
- **输出**：
  - 检索到的分块（含文本、表格、行、描述等）
  - 组装后的上下文，供LLM生成最终答案

---

## 五、可扩展性与未来优化
- 支持更多文档类型（如PDF、CSV）时，按parser模式扩展。
- 分块策略、描述生成、关键词提取等可配置和优化。
- 评估与反馈机制驱动持续优化。

---

## 六、总结

本方案结合现有项目结构与最佳实践，明确了各环节的职责与接口，确保文档和表格数据的精准解析、结构化、分块、向量化、上下文链接与高效检索，为RAG系统的高质量生成提供坚实基础。 